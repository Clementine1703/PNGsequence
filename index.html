<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Main</title>
	<style>
		* {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }


		html, body {
			scroll-behavior: smooth;
			height: 100%;
			/* overflow-x: hidden; */
		}

		/* @media (prefers-redused-motion: reduce){
			html, body {
			scroll-behavior: auto;
		}
		} */

		body{
			width: 100%;
			min-height: 100vh;
		}

		.preloader{
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			position: fixed;
			width: 100%;
			height: 100vh;
			z-index: 100;
			background-color: white;
		}

		.site-content{
			position: absolute;
			width: 100%;
			top: 350vh;
			z-index: -1;
		}

		.block{
			width: 100%;
			height: 100vh;
			border: 10px solid black;
		}

		.video-block1{
			-o-object-fit: cover;
    		object-fit: cover;
      	width: 100%;
      	height: 100%;
      	top: 0;
      	left: 0;

		}

		.block2{
			background: url(slides/slide_2.png) no-repeat center center;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;	
		}

		.block2__machine-content{
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			width: 70%;
			height: 30%;
			margin: 2% auto;
			background-color: yellow;
		}
		.block2__description{
			width: 70%;
			height: 54%;
			background-color: white;
			margin: 3% auto;
			padding: 10px 10%;
			text-align: justify;
			overflow-y: auto;

		}

		.block3{
		  overflow-x: auto;
		}

		.block3__content{
			background: url(slides/slide_3.png) no-repeat center center;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
			height: 100%;
			width: 300%;
		}


		.background{
			position: fixed;
			width: 100%;
			height: 100vh;
		}

		.container{
			width: 100%;
			height: 450vh;
		}

		.hidden{
			display: none;
		}

		.disable-scroll{
			position: relative;
			overflow: hidden;
			height: 100vh;
			position: fixed;
			left: 0;
			top: 0;
			width: 100%;
		}

	</style>
</head>
<body >
	<div class="preloader" id="preloader">
		<div><p style="font-size: 30px;">Загрузка...</p></div><br>
		<div>{{ downloadedImages }}/{{ allImages }}</div>
	</div>
	

	<div class="background">
		<canvas id="bgAnimation" ></canvas>
	</div>

	<div class="container disable-scroll">
		<div class="site-content">
			<div class="block block1">
				<video class="video-block1" autoplay loop muted preload>
					<source src="slides/slide_1.mp4" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'>
				  </video>
			</div>
			<div class="block block2">
				<div class="block2__machine-content">
					<h1 style="color: red;">--Машина-контент--</h1>
				</div>
				<div class="block2__description">
					<p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.Lorem ipsum dolor, sit amet consectetur adipisicing elit. Accusantium ea corporis quasi quam dignissimos corrupti. Natus assumenda voluptate voluptatum omnis rerum placeat, cum dolor animi asperiores eum totam ratione a rem adipisci magnam, fugit accusamus nulla. Vel fuga voluptatem veritatis fugiat ipsa voluptatibus, saepe molestias odit provident consequuntur obcaecati. Corrupti repellat unde asperiores explicabo aspernatur itaque fugiat et mollitia consequatur laborum delectus non architecto, enim similique minima. Ad consectetur cupiditate eius odit tempore aspernatur aut provident. Numquam iure culpa ullam, unde, consectetur voluptatem delectus vitae natus asperiores velit accusantium libero totam veritatis magnam maxime? Saepe repudiandae inventore necessitatibus laudantium enim.</p>
				</div>
			</div>
			<div class="block block3">
				<div class="block3__content"></div>
			</div>
			<div class="block block4"></div>
			<div class="block block5"></div>
		</div>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.0.5/vue.min.js"></script>


	<script type="text/javascript">

				window.onbeforeunload = function () { window.scrollTo(0, 0); }

				const countOfImages = 179;
				const imageURL = 'bg_images/babina30fps_jpeg_v3<number_of_image>.jpg';
				// let context_scalled = false;
				let preloadImagesCounter = 1;
				let context_visible = true;
				let contentBlock = document.querySelector('.site-content');
				let canvas_conteiner = document.querySelector('.background');
				let video_block1 = document.querySelector('.block1-video');
				let content_container = document.querySelector('.container');
				let imagesList = [];


		document.addEventListener('DOMContentLoaded', ()=>{

			window.scrollTo(0, 0);

			function enable_scroll(){
				content_container.classList.remove('disable-scroll');
			}

			// ф-я, которая удаляет preloader
			function deletePreloader(){
				var preloader = document.querySelector(".preloader");
				preloader.parentNode.removeChild(preloader);
			}


			// ф-я предзагрузки всех изображений фона (удаляет preloader после того как все изображения загружены) и запускает основную анимацию
			function preload(arrayOfImages) {
    			$(arrayOfImages).each(function(){
				let photo = new Image();
        		photo.src = this;
				photo.onload = ()=>{
					if (preloadImagesCounter < countOfImages){
						imagesList.push(photo); //для того чтобы фото оставались в памяти
						preloadImagesCounter++;
						preloader_app?preloader_app.downloadedImages = preloadImagesCounter:null;
					}
					else {
							console.log(imagesList);
							deletePreloader();
							enable_scroll();
							main();
							return 0;
					}
					
				}
    			});
			}

			// формирует список с url изображений для их дальнейшей предзагрузки. Работает
			// с константой imageSRC и подставляет вместо заглушки число от 0 до количества изображений
			function createPreloaderList() {
				let preload_list = [];
    			for (let i = 0; i < countOfImages; i++){
					let replace_value = i;
					let replace_value_str = replace_value.toString();
					for (let k = 0; k < countOfImages.toString().length - replace_value.toString().length; k++){
					replace_value_str = '0' + replace_value_str;
					}
					let preload_src = imageURL.replace('<number_of_image>', replace_value_str);
					preload_list.push(preload_src);
				}
				return preload_list;
				
			}


			preload(createPreloaderList());


			function main(){
			// ф-я создающая объект для работы с анимацией
			function sprite (options) {
				var that = {};
				that.context = options.context;
				that.width = options.width;
				that.height = options.height;
				that.image = options.image;
				
				// ф-я отрисовывает новое фото фона
				that.render = function () {

				that.context.clearRect(0, 0, canvas.width, canvas.height);

				// Draw the animation
				let scaleW = that.width/window.innerWidth;
				let scaleY = that.height/window.innerHeight;
				that.context.drawImage(
					that.image,
					0,
					0,
					that.width,
					that.height,
					0,
					0,
					that.width/scaleW,
					that.height/scaleY);
				};
				
				return that;
			}

			function check_changes(){
				if (exScrollValue != Math.floor(window.scrollY)){
					changeImage();
					exScrollValue = Math.floor(window.scrollY);
				}

				if (contentBlock.getBoundingClientRect().top <= 0){
					canvas_conteiner.classList.add('hidden');
				}
				else {
					canvas_conteiner.classList.remove('hidden');
				}
			}

			// ф-я, которая меняет задний фон в зависимости от прокрутки страницы
			function changeImage(){
				let numberOfImage = String(Math.floor(window.scrollY/((document.body.scrollHeight - window.innerHeight)/countOfImages)));
				numberOfImage_str = numberOfImage
				for (let i = 0; i < String(countOfImages).length - numberOfImage.length; i++){
					numberOfImage_str = '0' + numberOfImage_str;
				}

				bg.image.src = imageURL.replace('<number_of_image>', numberOfImage_str);
				bg.image.onload = ()=>{
				bg.render();
			}
			}


			var bgImage = new Image();
			bgImage.src = "bg_images/babina30fps_jpeg_v3000.jpg";
			

			var canvas = document.getElementById("bgAnimation");
			canvas.width = innerWidth;
			canvas.height = innerHeight;

			var bg = sprite({
    		context: canvas.getContext("2d"),
    		width: 1920,
    		height: 1080,
    		image: bgImage
			});


			bg.image.onload = ()=>{
				bg.render();
				check_changes()
			}

			let exScrollValue = 0;
			window.addEventListener('scroll', ()=>{
				check_changes();
			})

			window.addEventListener('resize', ()=>{
				changeImage();
				canvas.width = innerWidth;
				canvas.height = innerHeight;
			})




			// window.addEventListener('wheel', ()=>{
			// 	if (exScrollValue != Math.floor(window.scrollY)){
			// 		changeImage();
			// 		exScrollValue = Math.floor(window.scrollY);
			// 	}
			// })

			// setInterval(()=>{
			// 	if (exScrollValue != Math.floor(window.scrollY)){
			// 		changeImage();
			// 		exScrollValue = Math.floor(window.scrollY);
			// 	}



			// 	if (window.pageYOffset = (document.body.scrollHeight - window.innerHeight)){
			// 		canvas.classList.add('hidden');
			// 		console.log('a');
			// 	}
			// }, 50)


		}

			
		})




		const preloader_app = new Vue({
		  				el: '#preloader',
		  				data: {
			 				downloadedImages: preloadImagesCounter,
			 				allImages: countOfImages,
		  				},
				})

	</script>

</body>
</html>