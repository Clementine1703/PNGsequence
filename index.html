<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Main</title>
	<style>
		*{
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		html, body {
			scroll-behavior: smooth;
		}

		/* @media (prefers-redused-motion: reduce){
			html, body {
			scroll-behavior: auto;
		}
		} */

		body{
			width: 100%;
			min-height: 100vh;
		}

		.preloader{
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			position: fixed;
			width: 100%;
			height: 100vh;
			z-index: 100;
			background-color: white;
		}

		.site-content{
			position: absolute;
			width: 100%;
			top: 350vh;
			z-index: -1;
		}

		.block{
			width: 100%;
			height: 100vh;
			border: 10px solid black;
		}

		.video-slide1 video{
			width: 100vw;
			height: 100vh;
		}

		.background{
			position: fixed;
			width: 100%;
			height: 100vh;
		}

		.container{
			width: 100%;
			height: 450vh;
		}

		.hidden{
			display: none;
		}

	</style>
</head>
<body>
	<div class="preloader" id="preloader">
		<div><p style="font-size: 30px;">Загрузка...</p></div><br>
		<div>{{ downloadedImages }}/{{ allImages }}</div>
	</div>
	

	<div class="background">
		<canvas id="bgAnimation" ></canvas>
	</div>

	<div class="container">
		<div class="site-content">
			<div class="block block1"></div>
			<div class="block block2"></div>
			<div class="block block3"></div>
			<div class="block block4"></div>
			<div class="block block5"></div>
		</div>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.0.5/vue.min.js"></script>

	
	<script type="text/javascript">

				const countOfImages = 179;
				const imageURL = 'bg_images/babina30fps_jpeg_v3<number_of_image>.jpg';
				// let context_scalled = false;
				let preloadImagesCounter = 1;
				let context_visible = true;
				let contentBlock = document.querySelector('.site-content');
				let canvas_conteiner = document.querySelector('.background')


		document.addEventListener('DOMContentLoaded', ()=>{

			// ф-я, которая удаляет preloader
			function deletePreloader(){
				var preloader = document.querySelector(".preloader");
				preloader.parentNode.removeChild(preloader);
			}


			// ф-я предзагрузки всех изображений фона (удаляет preloader после того как все изображения загружены) и запускает основную анимацию
			function preload(arrayOfImages) {
    			$(arrayOfImages).each(function(){
				let photo = new Image();
        		photo.src = this;
				photo.onload = ()=>{
					if (preloadImagesCounter < countOfImages){
						preloadImagesCounter++;
						preloader_app?preloader_app.downloadedImages = preloadImagesCounter:null;
					}
					else {
						deletePreloader();
						main();
						return 0;
					}
					
				}
    			});
			}

			// формирует список с url изображений для их дальнейшей предзагрузки. Работает
			// с константой imageSRC и подставляет вместо заглушки число от 0 до количества изображений
			function createPreloaderList() {
				let preload_list = [];
    			for (let i = 0; i < countOfImages; i++){
					let replace_value = i;
					let replace_value_str = replace_value.toString();
					for (let k = 0; k < countOfImages.toString().length - replace_value.toString().length; k++){
					replace_value_str = '0' + replace_value_str;
					}
					let preload_src = imageURL.replace('<number_of_image>', replace_value_str);
					preload_list.push(preload_src);
				}
				return preload_list;
				
			}


			preload(createPreloaderList());


			function main(){
			// ф-я создающая объект для работы с анимацией
			function sprite (options) {
				var that = {};
				that.context = options.context;
				that.width = options.width;
				that.height = options.height;
				that.image = options.image;
				
				// ф-я отрисовывает новое фото фона
				that.render = function () {

				that.context.clearRect(0, 0, canvas.width, canvas.height);

				// Draw the animation
				let scaleW = that.width/window.innerWidth;
				let scaleY = that.height/window.innerHeight;
				that.context.drawImage(
					that.image,
					0,
					0,
					that.width,
					that.height,
					0,
					0,
					that.width/scaleW,
					that.height/scaleY);
				};
				
				return that;
			}

			// ф-я, которая меняет задний фон в зависимости от прокрутки страницы
			function changeImage(){
				let numberOfImage = String(Math.floor(window.scrollY/((document.body.scrollHeight - window.innerHeight)/countOfImages)));
				numberOfImage_str = numberOfImage
				for (let i = 0; i < String(countOfImages).length - numberOfImage.length; i++){
					numberOfImage_str = '0' + numberOfImage_str;
				}

				bg.image.src = imageURL.replace('<number_of_image>', numberOfImage_str);
				bg.image.onload = ()=>{
				bg.render();
			}
			}


			var bgImage = new Image();
			bgImage.src = "bg_images/babina30fps_jpeg_v3000.jpg";
			

			var canvas = document.getElementById("bgAnimation");
			canvas.width = innerWidth;
			canvas.height = innerHeight;

			var bg = sprite({
    		context: canvas.getContext("2d"),
    		width: 1920,
    		height: 1080,
    		image: bgImage
			});


			bg.image.onload = ()=>{
				bg.render();
			}

			let exScrollValue = 0;
			window.addEventListener('scroll', ()=>{
				if (exScrollValue != Math.floor(window.scrollY)){
					changeImage();
					exScrollValue = Math.floor(window.scrollY);
				}

				if (contentBlock.getBoundingClientRect().top <= 0){
					canvas_conteiner.classList.add('hidden');
				}
				else {
					canvas_conteiner.classList.remove('hidden');
				}
			})

			window.addEventListener('resize', ()=>{
				changeImage();
				canvas.width = innerWidth;
				canvas.height = innerHeight;
			})




			// window.addEventListener('wheel', ()=>{
			// 	if (exScrollValue != Math.floor(window.scrollY)){
			// 		changeImage();
			// 		exScrollValue = Math.floor(window.scrollY);
			// 	}
			// })

			// setInterval(()=>{
			// 	if (exScrollValue != Math.floor(window.scrollY)){
			// 		changeImage();
			// 		exScrollValue = Math.floor(window.scrollY);
			// 	}



			// 	if (window.pageYOffset = (document.body.scrollHeight - window.innerHeight)){
			// 		canvas.classList.add('hidden');
			// 		console.log('a');
			// 	}
			// }, 50)


		}

			
		})




		const preloader_app = new Vue({
		  				el: '#preloader',
		  				data: {
			 				downloadedImages: preloadImagesCounter,
			 				allImages: countOfImages,
		  				},
				})

	</script>
</body>
</html>